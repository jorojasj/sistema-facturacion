{% extends './base.html' %}
{% load static %}
{% block title %} Inicio {% endblock %}

{% block content %}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<div class="container mt-5 mb-5">
  <table class="table table-striped table-bordered">
      <thead class="thead-dark">
          <tr>
              <th scope="col">N°Orden</th>
              <th scope="col">Cliente</th>
              <th scope="col">Fecha</th>
              <th scope="col">Importe</th>
              <th scope="col">Estados</th>
              <th scope="col">Exportar</th>
          </tr>
      </thead>
      <tbody>
          {% for o in ordenes %}
          <tr>
              <th scope="row">{{o.numero_compra}}</th>
              <td>{{o.nombre_cliente}}</td>
              <td>{{o.fecha}}</td>
              <td>{{o.precio_producto}}</td>
              <td>
                {{o.get_estado_display}}
                <select name="estado-{{o.numero_compra}}" id="estado-select-{{o.numero_compra}}">
                    <option value="por_entregar">Por Entregar</option>
                    <option value="entregada">Entregada</option>
                    <option value="rechazada">Rechazada</option>
                </select>
                <!-- Formulario para el motivo de rechazo -->
                <form id="motivo-rechazo-form-{{o.numero_compra}}" style="display: none;">
                    <input type="text" name="motivo-{{o.numero_compra}}" placeholder="Motivo del rechazo">
                    <input type="hidden" name="orden_id" value="{{o.numero_compra}}">
                    <button type="submit">Enviar</button>
                </form>
              </td>
              <td><a class="btn btn-primary" href="{% url 'orden_compra' id_orden_compra=o.numero_compra%}">Descargar</a>
                <a class="btn btn-secondary" href="{% url 'editar_orden' id_orden=o.numero_compra %}">Editar</a>
               </td>
            </tr>
          {% endfor %}
      </tbody>
  </table>
</div>


<script>

function enviarMotivoRechazo() {
    // Asegúrate de que este código se ejecuta cuando el DOM esté completamente cargado
$(document).ready(function() {
    // Suponiendo que tu formulario tiene un ID específico
    $('#form-motivo-rechazo').submit(function(e) {
        e.preventDefault(); // Evita que el formulario se envíe de la manera tradicional

        var csrftoken = getCookie('csrftoken'); // Obtiene el token CSRF
        var motivoRechazo = $(this).find('textarea[name="motivo_rechazo"]').val(); // Asume que tienes un textarea para el motivo

        $.ajax({
            url: '/ruta/a/enviar_motivo_rechazo/',
            type: 'POST',
            data: {
                csrfmiddlewaretoken: csrftoken, // Incluir el token CSRF
                motivo_rechazo: motivoRechazo, // Asegúrate de enviar el motivo del rechazo
            },
            beforeSend: function(xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success: function(response) {
                if(response.status === 'success') {
                    alert('Motivo de rechazo enviado correctamente.');
                } else {
                    alert('Error al enviar el motivo del rechazo: ' + response.message);
                }
            },
            error: function() {
                alert('Error al enviar el motivo del rechazo. Por favor, intente de nuevo.');
            }
        });
    });
});
}



$('select[name^="estado-"]').change(function() {
    var estadoSeleccionado = $(this).val();
    if(estadoSeleccionado === 'rechazada') {
        enviarMotivoRechazo();
    }
});

  document.addEventListener('DOMContentLoaded', function() {
      {% for o in ordenes %}
      document.getElementById('estado-select-{{o.numero_compra}}').addEventListener('change', function() {
          var motivoRechazoForm = document.getElementById('motivo-rechazo-form-{{o.numero_compra}}');
          if (this.value === 'rechazada') {
              motivoRechazoForm.style.display = 'block';
          } else {
              motivoRechazoForm.style.display = 'none';
          }
      });

      $('#motivo-rechazo-form-{{o.numero_compra}}').submit(function(e) {
          e.preventDefault(); // Evita que el formulario se envíe de la manera tradicional
          var formData = $(this).serialize(); // Serializa los datos del formulario

          $.ajax({
              type: "POST",
              url: "{% url 'enviar_motivo_rechazo' %}", // Asegúrate de tener esta URL en tus urls.py
              data: formData,
              success: function(response) {
                  // Actualiza el historial de rechazos
                  $('#historial-rechazos').append('<p>Rechazado el ' + response.motivo + '</p>');
                  // Oculta el formulario de motivo de rechazo
                  $('#motivo-rechazo-form-{{o.numero_compra}}').hide();
              },
              error: function(response) {
                  // Maneja el error
                  alert('Error al enviar el motivo de rechazo.');
              }
          });
      });

      {% endfor %}
  });
</script>

<div class="container mt-4">
  <h3>Historial de Rechazos</h3>
  <div id="historial-rechazos">
      {% for motivo in entrega.motivos_rechazo.all %}
          <p>Rechazado el {{ motivo.fecha }}: {{ motivo.motivo }}</p>
      {% endfor %}
  </div>
</div>
{% endblock %}